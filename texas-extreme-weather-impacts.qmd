---
title: "texas-extreme-weather"
format: html
author: "Sofia Rodas"
date: "November 8, 2025"
message: false
warning: false
---

```{r}
#| output: false

# load in libraries
library(tidyverse)
library(tmap) # map making
library(sf)
library(stars) # raster handling
library(terra) # raster handling
library(kableExtra) # table creation

```
Reading in Nasa's Worldview data that will be used to analyze the effects of the power outages in Texas. February 7, 2021 and February 16, 2021 are the two dates analyzed as they provide clear skies for better analysis.
```{r}
# read in the NOAA data
light1_0207 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
light2_0207 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
light3_0216 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
light4_0216 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif"))
```
Road data in Texas is necessary to take account of light pollution that comes from roads. 
```{r}
#| output: false

# set a query so only highways are selected
road_query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

# read in road data
roads <- st_read(here::here("data/gis_osm_roads_free_1.gpkg"), query = road_query)

```
Part of this analysis will quantify the number of houses that experienced blackouts.
```{r}
#| output: false

# select for residential buildings
query_house <- "SELECT *
FROM gis_osm_buildings_a_free_1
WHERE (type IS NULL AND name IS NULL)
OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')"

# read in house data
houses <- st_read(here::here("data/gis_osm_buildings_a_free_1.gpkg"), query = query_house)
```
```{r}
#| output: false

st_layers(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"))
```
Read in the socioeconomic data 
```{r}
# socioeconomic geometry data read in
texas <- st_read(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "ACS_2019_5YR_TRACT_48_TEXAS")

# socioeconomic income data read in
texas_income <- read_sf(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "X19_INCOME")

```

## Check CRS for all of the data
```{r}
#| output: false

st_crs(light1_0207)
```
```{r}
#| output: false

st_crs(light2_0207)
```
```{r}
#| output: false

st_crs(light3_0216)
```
```{r}
#| output: false

st_crs(light4_0216)
```

```{r}
#| output: false

st_crs(houses)
```
```{r}
#| output: false

st_crs(roads)
```
```{r}
#| output: false

# check crs texas
st_crs(texas)
```

#### Making sure the CRS are the same for all of the datasets
Set the CRS to equal each other in a boolean to make sure they are all the same
```{r}
# Check that the same CRS are used for all of the data
if (st_crs(light1_0207)==st_crs(light2_0207)){
  print("it's a match!")
}else {
    warning("still not a match")
}


if (st_crs(light1_0207)==st_crs(light3_0216)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(light4_0216)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(houses)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(roads)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(texas)){
  print("it's a match!")
}else {
    warning("still not a match")
}
```
#### Change CRS for texas
```{r}
# change crs of texas
texas <- st_transform(texas, crs = st_crs(light1_0207))
```


# Merge data for the entirety of the days 
```{r}
# combine the data with st_mosaic since data has different extents
light_0207 <- st_mosaic(light1_0207, light2_0207)
light_0216 <- st_mosaic(light3_0216, light4_0216)
```
### Find the change in night lights intensity (presumably) caused by the storm
```{r}
# difference between the two dates boolean
# diff_light <- (light_0207 - light_0216) > 200

# assign na based on where the value is false for the boolean
# diff_light[diff_light == FALSE] <- NA
```

```{r}
# blackout data 
blackout <- light_0207 - light_0216 

# assign NA to any value less than 
blackout[blackout < 200 ] <- NA
```

# vectorize the blackout mask
```{r}
blackout <- blackout |> 
  st_as_sf() 
# st_make_valid() if anything is invalid
```

```{r}
# check if any of the geometries are invalid
unique(st_is_valid(blackout))
```

Crop (spatially subset) the blackout mask to the Houston area as defined by the following coordinates:
(-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)
```{r}
# st_bbox are not layers they are type bbox so we need to use st_as_sf to vectorize it
# use st_bbox
crop_bbox <- c(xmin = -96.5, ymin = 29, xmax = -94.5, ymax= 30.5)
st_crop(blackout, st_bbox(crop_bbox))
```

Re-project the cropped blackout dataset to EPSG:3083 (NAD83 / Texas Centric Albers Equal Area)
```{r}
# st_transform
blackout |> 
  st_transform(crs=st_crs('NAD83'))
```
Plot light for February 07, 2021
```{r}
plot(light_0207)
```

```{r}
tm_shape(blackout) + 
  tm_polygons() + 
  tm_shape(light_0207) +
  tm_raster(breaks = c(0, 1000, 2000, 3000, 4000, 5000))
```
```{r}
plot(nasa_0216)
```
```{r}
tm_shape(blackout) + 
  tm_polygons() + 
  tm_shape(light_0216) +
  tm_raster(breaks = c(0, 8000, 12000, 16000, 20000, 24000, 30000))

```
# Exclude highways from the cropped blackout mask
```{r}
# look at the units for the highways
st_crs(roads$unit)
# identify areas within 200m of all highways

```

