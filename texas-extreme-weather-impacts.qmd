---
title: "texas-extreme-weather"
format: html
author: "Sofia Rodas"
date: "November 8, 2025"
message: false
warning: false
---

```{r}
#| output: false

# load in libraries
library(tidyverse)
library(tmap) # map making
library(sf)
library(stars) # raster handling
library(terra) # raster handling
```
Reading in Nasa's Worldview data that will be used to analyze the effects of the power outages in Texas. February 7, 2021 and February 16, 2021 are the two dates analyzed as they provide clear skies for better analysis.
```{r}
# read in the NOAA data
light1_0207 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
light2_0207 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
light3_0216 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
light4_0216 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif"))
```
Road data in Texas is necessary to take account of light pollution that comes from roads. 
```{r}
#| output: false

# set a query so only highways are selected
road_query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

# read in road data
highways <- st_read(here::here("data/gis_osm_roads_free_1.gpkg"), query = road_query)

```
Part of this analysis will quantify the number of houses that experienced blackouts.
```{r}
#| output: false

# select for residential buildings
query_house <- "SELECT *
FROM gis_osm_buildings_a_free_1
WHERE (type IS NULL AND name IS NULL)
OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')"

# read in house data
houses <- st_read(here::here("data/gis_osm_buildings_a_free_1.gpkg"), query = query_house)
```
```{r}
#| output: false

st_layers(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"))
```
Read in the socioeconomic data 
```{r}
#| output: false

# socioeconomic geometry data read in
texas <- st_read(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "ACS_2019_5YR_TRACT_48_TEXAS")

# socioeconomic income data read in
texas_income <- read_sf(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "X19_INCOME")

```

## Check CRS for all of the data


#### Making sure the CRS are the same for all of the datasets
Set the CRS to equal each other in a boolean to make sure they are all the same
```{r}
# Check that the same CRS are used for all of the data
if (st_crs(light1_0207)==st_crs(light2_0207)){
  print("it's a match!")
}else {
    warning("still not a match")
}


if (st_crs(light1_0207)==st_crs(light3_0216)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(light4_0216)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(houses)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(highways)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(texas)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(light1_0207)==st_crs(texas_income)){
  print("it's a match!")
}else {
    warning("still not a match")
}
```
Make a for loop that checks that all of the CRS match for all of the data. 
```{r}

# WHY IS IT RUNNING SO MANY TIMES? HOW CAN I RUN STARS THROUGH THIS FOR LOOP?
df_name <- c(highways, houses)

for (i in seq_along(df_name)){
  
  if (st_crs(light1_0207)==st_crs(df_name)){
  print("it's a match!")
}else {
    warning("still not a match")
}
}
```

#### Change CRS for texas
```{r}
# change crs to texas crs
highways <- st_transform(highways, crs = st_crs('EPSG:3083'))
houses <- st_transform(houses, crs = st_crs('EPSG:3083'))
texas <- st_transform(texas, crs = st_crs('EPSG:3083'))
```


# Merge data for the entirety of the days 
```{r}
# combine the data with st_mosaic since data has different extents
light_0207 <- st_mosaic(light1_0207, light2_0207)
light_0216 <- st_mosaic(light3_0216, light4_0216)
```

# Create original maps 

### vectorize the light data
```{r}
# light_0207 <- light_0207 |> 
#   st_as_sf() 
# 
# light_0216 <- light_0216 |> 
#   st_as_sf()

# st_make_valid() if anything is invalid
```

### Check if there are any gemetries that are invalid
```{r}
# check if any of the geometries are invalid
# unique(st_is_valid(light_0207))
# unique(st_is_valid(light_0216))
```

### Crop (spatially subset) the blackout mask to the Houston area as defined by the following coordinates: (-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29)
```{r}
# st_bbox are not layers they are type bbox so we need to use st_as_sf to vectorize it
# use st_bbox
crop_bbox <- st_bbox(c(xmin = -96.5, ymin = 29, xmax = -94.5, ymax= 30.5), crs = st_crs(light_0207))
```


```{r}
# crop light data on 02/07
light_0207 <- st_crop(light_0207, crop_bbox)

# crop light data on 02/16
light_0216 <- st_crop(light_0216, crop_bbox)
```
Plot light for February 07, 2021
```{r}
plot(light_0207)
```

```{r}
lum_0207 <- tm_shape(light_0207) +
  tm_raster(palette = c('black', 
                        '#58544C',
                        'darkgrey', 
                        'grey', 
                        'lightgrey', 
                        'white'),
            breaks = c(0, 400, 800, 1200, 2400, 4800, 10000),
            title = "Luminence nW cm-2sr-1") +
  tm_title("Pre-Blackout Houston Luminence Map February 7, 2021") +
  tm_compass(position = tm_pos_out("right", "bottom")) +
  tm_scalebar(position = tm_pos_out("right", "bottom"))
```


```{r}
plot(light_0216)
```

```{r}
lum_0216 <- tm_shape(light_0216) +
  tm_raster(palette = c('black', 
                        '#58544C',
                        'darkgrey', 
                        'grey', 
                        'lightgrey',
                        'white'),
            breaks = c(0, 400, 800, 1200, 2400, 4800, 20000),
            title = "Luminence nW cm-2sr-1") +
  tm_title("Houston Luminence Map for Blackout February 16, 2021") +
  tm_compass(position = tm_pos_out("right", "bottom")) +
  tm_scalebar(position = tm_pos_out("right", "bottom")) 
```
```{r}
tmap_arrange(lum_0207, lum_0216)
```

# Create blackout mask
### Find the change in night lights intensity (presumably) caused by the storm
```{r}
# difference between the two dates boolean
# diff_light <- (light_0207 - light_0216) > 200

# assign na based on where the value is false for the boolean
# diff_light[diff_light == FALSE] <- NA
```

```{r}
# blackout data 
blackout <- light_0207 - light_0216 

# assign NA to any value less than 
blackout[blackout < 200 ] <- NA
```


### Re-project the cropped blackout dataset to EPSG:3083 (NAD83 / Texas Centric Albers Equal Area)
```{r}
# st_transform
blackout <- blackout |> 
  st_transform(crs=st_crs('EPSG:3083'))
```

Create map of the blackout
```{r} 
tm_shape(blackout) + 
  tm_raster(palette = c('black', 
                        '#58544C',
                        'darkgrey', 
                        'grey', 
                        'lightgrey',
                        'white'),
            breaks = c(0, 500, 800, 1200, 2400, 4800, 10000),
            title = "Luminence differences nW cm-2sr-1") +
  tm_title("Houston Blackout Areas February 2021") +
   tm_compass(position = tm_pos_out("right", "bottom")) +
  tm_scalebar(position = tm_pos_out("right", "bottom"))

```


# Exclude highways from the cropped blackout mask
```{r}
# look at the units for the highways, the analysis is based on meters
st_crs(highways, parameters = TRUE)$units_gdal
# highways <- st_transform(highways, crs = st_crs('EPSG:3083'))
# st_crs(highways, parameters = TRUE)$units_gdal

# combine geometry of highway buffer and highway itself
highways <- st_union(highways)

# identify areas within 200m of all highways
highway_buffer <- st_buffer(highways, dist = 200)

```

```{r}
# make sure geometry is valid 
unique(st_is_valid(highway_buffer))
```
```{r}
# make sure crs match before finding the difference
st_crs(highway_buffer)==st_crs(blackout)
```

```{r}
# change crs of blackout data to match exc_highway crs
# blackout <- st_transform(blackout, crs = st_crs('EPSG:3083'))
# highway_buffer <- st_transform(highway_buffer, crs = st_crs('EPSG:3083'))

# change blackout data to a vector 
st_blackout <- st_as_sf(blackout)

# find true blackout areas that are further than 200 meters from a highway
true_blackout <- st_difference(st_blackout, highway_buffer)
```
```{r}
# map blackout areas more than 200 meters from homes and highways for reference 
tm_shape(true_blackout) +
  tm_polygons() +
tm_shape(highway_buffer) +
  tm_lines(col = '#ED6A5A') +
  tm_add_legend(title = "Roads",
                 type = "line",
                 labels = "highway") +
   tm_title("Houston Blackout Areas February 2021") +
   tm_compass(position = tm_pos_out("right", "bottom")) +
   tm_scalebar(position = tm_pos_out("right", "bottom"))
```

# Identify the number of homes likely impacted by blackouts
```{r}
# make sure crs match 
st_crs(true_blackout) == st_crs(houses)

# find number of homes that intersect with the blackout data                         
blackedout_homes <- st_intersection(true_blackout, houses)
```
Approximately 169,469 homes were likely impacted by the blackouts in Houston. This analysis is based on any homes that intersected with the blackout areas. Some of the homes in the intersection may not have experienced blackouts.
```{r}
tm_shape(blackedout_homes) +
  tm_polygons() +
  tm_shape(highway_buffer) +
  tm_lines(col = '#ED6A5A') +
  tm_add_legend(title = "Roads",
                 type = "line",
                 labels = "highway") +
   tm_title("Homes in Houston's Blackout Areas February 2021") +
   tm_compass(position = tm_pos_out("right", "bottom")) +
   tm_scalebar(position = tm_pos_out("right", "bottom"))
```
### Combine Texas geometry with socioeconomic data
```{r}
# left_joining since we do not need all of the information in the texas df
texas_socioeconomics <- full_join(texas, texas_income, by = "GEOID")
```

Based on the metadata median household income in the past 12 months is column 'B19013e1'.
```{r}
#| eval: false

# make sure that geometry is maintained 
st_crs(texas_socioeconomics)

# check if there are any values that are not NA
unique(texas_socioeconomics$B19013e1)

st_crs(texas_socioeconomics) == st_crs(blackedout_homes)
```
```{r}
# subset data only data that overlaps with blackedout homes
blackedout_socioecon <- st_intersects(texas_socioeconomics, blackedout_homes)

# subset data for those that are not overlapping at all
notblackedout_socioecon <- st_disjoint(texas_socioeconomics, blackedout_homes)
```

```{r}
unique(blackedout_socioecon$B19013e1)
```

```{r}
# ggplot(blackedout_socioecon, aes(B19013e1))+
#   geom_histogram()
```


# Refrences
```{r}

```

