---
title: "texas-extreme-weather"
format: html
author: "Sofia Rodas"
date: "November 8, 2025"
message: false
warning: false
---

```{r}
#| output: false

# load in libraries
library(tidyverse)
library(tmap) # map making
library(sf)
library(stars) # raster handling
library(terra) # raster handling
library(kableExtra) # table creation

```
Reading in Nasa's Worldview data that will be used to analyze the effects of the power outages in Texas. February 7, 2021 and February 16, 2021 are the two dates analyzed as they provide clear skies for better analysis.
```{r}
# read in the NOAA data
nasa1_0207 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif"))
nasa2_0207 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
nasa3_0216 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
nasa4_0216 <- read_stars(here::here("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif"))
```
Road data in Texas is necessary to take account of light pollution that comes from roads. 
```{r}
#| output: false

# set a query so only highways are selected
road_query <- "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'"

# read in road data
roads <- st_read(here::here("data/gis_osm_roads_free_1.gpkg"), query = road_query)

```
Part of this analysis will quantify the number of houses that experienced blackouts.
```{r}
#| output: false

# select for residential buildings
query_house <- "SELECT *
FROM gis_osm_buildings_a_free_1
WHERE (type IS NULL AND name IS NULL)
OR type in ('residential', 'apartments', 'house', 'static_caravan', 'detached')"

# read in house data
houses <- st_read(here::here("data/gis_osm_buildings_a_free_1.gpkg"), query = query_house)
```
```{r}
# socioeconomic data read in
texas <- st_read(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"), layer = "ACS_2019_5YR_TRACT_48_TEXAS")
```

## Check CRS for all of the data
```{r}
#| output: false

st_crs(nasa1_0207)
```
```{r}
#| output: false

st_crs(nasa2_0207)
```
```{r}
#| output: false

st_crs(nasa3_0216)
```
```{r}
#| output: false

st_crs(nasa4_0216)
```

```{r}
#| output: false

st_crs(houses)
```
```{r}
#| output: false

st_crs(roads)
```
```{r}
#| output: false

# check crs texas
st_crs(texas)
```

#### Making sure the CRS are the same for all of the datasets
Set the CRS to equal each other in a boolean to make sure they are all the same
```{r}
# Check that the same CRS are used for all of the data
if (st_crs(nasa1_0207)==st_crs(nasa2_0207)){
  print("it's a match!")
}else {
    warning("still not a match")
}


if (st_crs(nasa1_0207)==st_crs(nasa3_0216)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(nasa1_0207)==st_crs(nasa4_0216)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(nasa1_0207)==st_crs(houses)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(nasa1_0207)==st_crs(roads)){
  print("it's a match!")
}else {
    warning("still not a match")
}

if (st_crs(nasa1_0207)==st_crs(texas)){
  print("it's a match!")
}else {
    warning("still not a match")
}
```
#### Change CRS for texas
```{r}
# change crs of texas
texas <- st_transform(texas, crs = st_crs(nasa1_0207))
```

```{r}
# # Create a raster with smaller extent
# clip <- rast(xmin = -113.3, 
#              xmax = -113, 
#              ymin =37.2, 
#              ymax = 37.9,
#              resolution = 0.3,
#              vals = 1) # give each cell a value of one
# 
# # Select values that fall withing smaller extent
# zion_elevation_clip <- zion_elevation[clip]
```

# Merge data for the entirety of the days 
```{r}
st_bbox(nasa1_0207)
st_bbox(nasa2_0207)
st_bbox(nasa3_0216)
st_bbox(nasa4_0216)

nasa_0207 <- c(nasa1_0207, nasa2_0207, along = 'x')
nasa_0216 <- c(nasa3_0216, nasa4_0216, along = 'x')

```


Initial exploration of the NASA Worldview data
```{r}
# noaa_map1 <- tm_shape(nasa1) +
#   tm_raster( )
# 
# noaa_map1
```

